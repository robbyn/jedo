<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapping PUBLIC '-//tastefuljava.org//Jedo Mapping File 1.0//EN' 'jedo.dtd'>
<mapping package="org.tastefuljava.jedo.testdb">
    <class name="Named">
        <discriminator>
            <when condition="not-null" column="FID">Folder</when> 
            <when condition="not-null" column="PID">Folder</when> 
        </discriminator>
        <id>
            <field name="id" column="ID"/>
        </id>
        <field name="name" column="NAME"/>
        <load>
            SELECT named.ID ID, named.NAME NAME, folders.ID FID, 
                folders.PARENT_ID PARENT_ID, pictures.ID PID,
                pictures.FOLDER_ID FOLDER_ID, ,TIMESTAMP,WIDTH,HEIGHT,LATITUDE,
                LONGITUDE,ALTITUDE
            FROM named
                LEFT OUTER JOIN folders ON (folders.ID=named.ID)
                LEFT OUTER JOIN pictures ON (pictures.ID=named.ID)
            WHERE name.ID=${id}
        </load>
        <insert get-generated-keys="true">
            INSERT INTO named(NAME)
            VALUES(${name})
        </insert>
    </class>
    <class name="Folder">
        <inherits class="Named"/>
        <reference name="parent" column="PARENT_ID" fetch-mode="lazy"/>
        <set name="subfolders" fetch-mode="lazy">
            <fetch>
                SELECT named.ID ID, named.NAME NAME, folders.PARENT_ID PARENT_ID
                FROM folders JOIN named ON (folders.ID=named.ID)
                WHERE PARENT_ID=${id}
            </fetch>
            <add parent="parent" element="child">
                UPDATE folders
                SET PARENT_ID=${parent.id}
                WHERE ID=${id}
            </add>
            <remove parent="parent" element="child">
                UPDATE folders
                SET PARENT_ID=NULL
                WHERE PARENT_ID=${parent.id} AND ID=${id}
            </remove>
            <clear parent="parent">
                DELETE FROM folders
                WHERE FOLDER_ID=${id}
            </clear>
        </set>
        <set name="pictures" fetch-mode="lazy">
            <fetch parent="folder">
                SELECT named.ID ID, named.NAME NAME, pictures.ID PID,FOLDER_ID,
                    TIMESTAMP,WIDTH,HEIGHT,LATITUDE,LONGITUDE,ALTITUDE
                FROM pictures
                    JOIN named ON (pictures.ID=named.ID)
                WHERE FOLDER_ID=${id}
            </fetch>
            <add parent="folder" element="picture">
                UPDATE pictures
                SET FOLDER_ID=${folder.id}
                WHERE ID=${id}
            </add>
            <remove parent="folder" element="picture">
                DELETE FROM pictures
                WHERE FOLDER_ID=${folder.id} AND ID=${id}
            </remove>
            <clear parent="folder">
                DELETE FROM pictures
                WHERE FOLDER_ID=${id}
            </clear>
        </set>

        <load>
            SELECT named.ID ID, named.NAME NAME, folders.PARENT_ID PARENT_ID
            FROM folders JOIN named ON (folders.ID=named.ID)
            WHERE folders.ID=${id}
        </load>
        <query name="rootFolder" parameters="name">
            SELECT named.ID ID, named.NAME NAME, folders.PARENT_ID PARENT_ID
            FROM folders JOIN named ON (folders.ID=named.ID)
            WHERE PARENT_ID IS NULL
                AND NAME=${name}
        </query>
        <query name="subfolder" parameters="parent,name">
            SELECT named.ID ID, named.NAME NAME, folders.PARENT_ID PARENT_ID
            FROM folders JOIN named ON (folders.ID=named.ID)
            WHERE PARENT_ID=${parent.id}
                AND NAME=${name}
        </query>
        <insert>
            INSERT INTO folders(ID,PARENT_ID)
            VALUES(${id},${parent.id})
        </insert>
    </class>

    <class name="Picture">
        <inherits class="Named"/>
        <reference name="folder" column="FOLDER_ID"/>
        <field name="timestamp" column="TIMESTAMP"/>
        <field name="width" column="WIDTH"/>
        <field name="height" column="HEIGHT"/>
        <component name="gpsData">
            <field name="latitude" column="LATITUDE"/>
            <field name="longitude" column="LONGITUDE"/>
            <field name="altitude" column="ALTITUDE"/>
        </component>
        <list name="tags" fetch-mode="eager">
            <element column="NAME"/>
            <fetch>
                SELECT * FROM picture_tags
                WHERE PICTURE_ID=${id}
                ORDER BY PICTURE_ID,INDEX
            </fetch>
            <add-at parent="picture" element="tag" index="index">
                INSERT INTO picture_tags(PICTURE_ID,INDEX,NAME)
                VALUES(${picture.id},${index},${tag})
            </add-at>
            <clear parent="picture">
                DELETE FROM picture_tags
                WHERE PICTURE_ID=${id}
            </clear>
        </list>
        <map name="descriptions" fetch-mode="lazy">
            <key column="LANGUAGE"/>
            <element column="DESCRIPTION"/>
            <fetch>
                SELECT * FROM picture_descriptions
                WHERE PICTURE_ID=${id}
            </fetch>
            <put parent="picture" key="language" element="description">
                INSERT INTO picture_descriptions(PICTURE_ID,LANGUAGE,DESCRIPTION)
                VALUES(${picture.id},${language},${description})
            </put>
            <remove-key parent="picture" key="language">
                DELETE FROM picture_tags
                WHERE PICTURE_ID=${id} AND LANGUAGE=${language}
            </remove-key>
            <clear parent="picture_descriptions">
                DELETE FROM picture_tags
                WHERE PICTURE_ID=${id}
            </clear>
        </map>

        <load>
            SELECT named.ID ID, named.NAME NAME, pictures.ID PID,FOLDER_ID,
                TIMESTAMP,WIDTH,HEIGHT,LATITUDE,LONGITUDE,ALTITUDE
            FROM pictures
                JOIN named ON (pictures.ID=named.ID)
            WHERE pictures.ID=${id}
        </load>
        <query name="byName" parameters="folder,name">
            SELECT named.ID ID, named.NAME NAME, pictures.ID PID,FOLDER_ID,
                TIMESTAMP,WIDTH,HEIGHT,LATITUDE,LONGITUDE,ALTITUDE
            FROM pictures
                JOIN named ON (pictures.ID=named.ID)
            WHERE FOLDER_ID=${folder.id}
                AND NAME=${name}
        </query>
        <insert>
            INSERT INTO pictures(ID,FOLDER_ID,TIMESTAMP,WIDTH,HEIGHT,LATITUDE,
                LONGITUDE,ALTITUDE)
            VALUES(${id},${folder.id},${timestamp:TIMESTAMP},${width},
                ${height},${gpsData.latitude},${gpsData.longitude},
                ${gpsData.altitude})
        </insert>
        <update>
            UPDATE pictures SET FOLDER_ID=${folder.id},NAME=${name},
                TIMESTAMP=${timestamp:TIMESTAMP},WIDTH=${width},
                HEIGHT=${height},LATITUDE=${gpsData.latitude},
                LONGITUDE=${gpsData.longitude},
                ALTITUDE=${gpsData.altitude}
            WHERE ID=${id}
        </update>
        <delete>
            DELETE FROM pictures WHERE ID=${id}
        </delete>
    </class>
</mapping>
